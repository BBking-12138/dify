# 使用官方的Postgres镜像作为基础镜像
FROM postgres:15-alpine

# 设置环境变量
ENV PGUSER=${PGUSER:-postgres}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-difyai123456}
ENV POSTGRES_DB=${POSTGRES_DB:-dify}
ENV PGDATA=${PGDATA:-/var/lib/postgresql/data/pgdata}
ENV POSTGRES_MAX_CONNECTIONS=${POSTGRES_MAX_CONNECTIONS:-100}
ENV POSTGRES_SHARED_BUFFERS=${POSTGRES_SHARED_BUFFERS:-128MB}
ENV POSTGRES_WORK_MEM=${POSTGRES_WORK_MEM:-4MB}
ENV POSTGRES_MAINTENANCE_WORK_MEM=${POSTGRES_MAINTENANCE_WORK_MEM:-64MB}
ENV POSTGRES_EFFECTIVE_CACHE_SIZE=${POSTGRES_EFFECTIVE_CACHE_SIZE:-4096MB}

# 挂载卷
#VOLUME /var/lib/postgresql/data
RUN echo "PGUSER: ${PGUSER}" && \
    echo "POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}" && \
    echo "POSTGRES_DB: ${POSTGRES_DB}" && \
    echo "PGDATA: ${PGDATA}" && \
    echo "POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS}" && \
    echo "POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS}" && \
    echo "POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM}" && \
    echo "POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM}" && \
    echo "POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE}"

# 启动命令
# CMD ["postgres", "-c", "max_connections=${POSTGRES_MAX_CONNECTIONS}", "-c", "shared_buffers=${POSTGRES_SHARED_BUFFERS}", "-c", "work_mem=${POSTGRES_WORK_MEM}", "-c", "maintenance_work_mem=${POSTGRES_MAINTENANCE_WORK_MEM}", "-c", "effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE}"]

# 健康检查
HEALTHCHECK --interval=1s --timeout=3s --start-period=5s --retries=30 CMD pg_isready -U ${PGUSER} -d ${POSTGRES_DB}